<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sinal Autom√°tico - Pullback M5 (Deriv)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; }
    canvas { max-width: 100%; background: #222; border: 1px solid #555; }
    select, button { margin: 10px; padding: 6px; }
    #sinal { font-size: 24px; font-weight: bold; margin-top: 10px; }
    #historico { margin-top: 20px; max-height: 200px; overflow-y: auto; }
    table { margin: 0 auto; border-collapse: collapse; }
    td, th { border: 1px solid #777; padding: 5px; }
  </style>
</head>
<body>
  <h2>Sistema de Sinais - Pullback com Rejei√ß√£o (Deriv)</h2>

  <div>
    Ativo:
    <select id="pair">
      <option value="R_100">Volatility 100 (R_100)</option>
      <option value="R_75">Volatility 75 (R_75)</option>
      <option value="frxUSDJPY">USD/JPY</option>
      <option value="frxEURUSD">EUR/USD</option>
    </select>
    Tempo:
    <select id="interval">
      <option value="60">M1</option>
      <option value="300" selected>M5</option>
      <option value="900">M15</option>
    </select>
    <button onclick="carregar()">Atualizar</button>
  </div>

  <canvas id="grafico" width="800" height="400"></canvas>
  <div id="sinal">Analisando...</div>

  <div id="historico">
    <h4>Hist√≥rico de Sinais</h4>
    <table id="tabela">
      <tr><th>Hora</th><th>Par</th><th>Sinal</th><th>Resultado</th></tr>
    </table>
  </div>

  <audio id="alerta" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    let chart;
    let candles = [];
    let ws;
    let sinaisPendentes = [];
    const app_id = 1089;
    let pingInterval;

    function carregar() {
      if (ws) {
        ws.close();
        clearInterval(pingInterval);
      }

      candles = [];

      const symbol = document.getElementById("pair").value;
      const interval = parseInt(document.getElementById("interval").value);

      // Conex√£o WebSocket correta com app_id
      ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${app_id}`);

      ws.onopen = () => {
        console.log("‚úÖ WebSocket conectado!");

        // Enviar a requisi√ß√£o inicial
        const req = {
          ticks_history: symbol,
          adjust_start_time: 1,
          count: 50,
          granularity: interval,
          style: "candles",
          subscribe: 1
        };
        ws.send(JSON.stringify(req));

        // Pingar a cada 120s
        pingInterval = setInterval(() => {
          ws.send(JSON.stringify({ ping: 1 }));
          console.log("üîÑ Ping enviado ao WebSocket");
        }, 120000);
      };

      ws.onerror = (err) => {
        console.error("‚ùå Erro no WebSocket:", err);
      };

      ws.onclose = () => {
        console.warn("‚ö†Ô∏è WebSocket foi fechado.");
        clearInterval(pingInterval);
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.candles) {
          candles = data.candles.map(c => ({
            time: new Date(c.epoch * 1000).toLocaleTimeString(),
            open: c.open,
            high: c.high,
            low: c.low,
            close: c.close
          }));
          desenharGrafico();
          analisarSinal(symbol);
          verificarSinais();
        } else if (data.candle) {
          const c = data.candle;
          const novo = {
            time: new Date(c.epoch * 1000).toLocaleTimeString(),
            open: c.open,
            high: c.high,
            low: c.low,
            close: c.close
          };
          candles.push(novo);
          if (candles.length > 50) candles.shift();
          atualizarGrafico();
          analisarSinal(symbol);
          verificarSinais();
        }
      };
    }

    function desenharGrafico() {
      const closes = candles.map(c => c.close);
      const labels = candles.map(c => c.time);
      const ctx = document.getElementById('grafico').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Fechamento',
            data: closes,
            borderColor: 'lime',
            backgroundColor: 'rgba(0,255,0,0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          animation: { duration: 1000 },
          scales: { y: { beginAtZero: false } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function atualizarGrafico() {
      chart.data.labels = candles.map(c => c.time);
      chart.data.datasets[0].data = candles.map(c => c.close);
      chart.update();
    }

    function analisarSinal(par) {
      const ultimas = candles.slice(-4);
      if (ultimas.length < 4) return;

      const anterior = ultimas[0].close;
      const forca = ultimas[1].close > ultimas[1].open;
      const rejeicao = ultimas[2].close < ultimas[2].open &&
        (ultimas[2].open - ultimas[2].close) > (ultimas[2].high - ultimas[2].low) * 0.4;

      const sinalDiv = document.getElementById('sinal');
      if (forca && rejeicao && ultimas[1].close >= anterior) {
        sinalDiv.innerText = `SINAL: PUT detectado!`;
        sinalDiv.style.color = 'red';
        document.getElementById('alerta').play();
        adicionarHistorico(par, 'PUT', candles.length - 2);
      } else {
        sinalDiv.innerText = "Nenhum sinal no momento.";
        sinalDiv.style.color = 'white';
      }
    }

    function adicionarHistorico(par, direcao, index) {
      sinaisPendentes.push({ index, par, direcao, resolvido: false });
      const tabela = document.getElementById('tabela');
      const tr = document.createElement('tr');
      tr.setAttribute('data-index', index);
      const hora = new Date().toLocaleTimeString();
      tr.innerHTML = `<td>${hora}</td><td>${par}</td><td>${direcao}</td><td id="resultado-${index}">‚è≥</td>`;
      tabela.appendChild(tr);
    }

    function verificarSinais() {
      sinaisPendentes.forEach(sinal => {
        if (!sinal.resolvido && candles[sinal.index + 1]) {
          const entrada = candles[sinal.index];
          const resultado = candles[sinal.index + 1];
          const green = sinal.direcao === 'PUT' ? resultado.close < entrada.close : false;
          const td = document.getElementById(`resultado-${sinal.index}`);
          td.textContent = green ? '‚úÖ GREEN' : '‚ùå RED';
          td.style.color = green ? 'lime' : 'red';
          sinal.resolvido = true;
        }
      });
    }

    carregar(); // inicia automaticamente
  </script>
</body>
</html>
