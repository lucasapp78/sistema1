<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sinais Forex - Entrada CALL ou PUT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      text-align: center;
    }
    h1 {
      margin: 20px;
    }
    #pairSelect {
      padding: 5px;
      font-size: 16px;
    }
    .sinal {
      font-size: 20px;
      font-weight: bold;
      margin: 15px 0;
    }
    .sinal span {
      font-weight: bold;
    }
    #sinal_box {
      margin-top: 20px;
      padding: 20px;
      background: #ddd;
      border-radius: 10px;
    }
    .alerta {
      font-size: 24px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <h1>üß† Sinais de Entrada - Pullback com Rejei√ß√£o</h1>

  <label>Par de moedas:</label>
  <select id="pairSelect">
    <option value="EUR/USD">EUR/USD</option>
    <option value="GBP/USD">GBP/USD</option>
    <option value="USD/JPY">USD/JPY</option>
  </select>

  <div id="tradingview_chart" style="height: 600px; margin-top: 20px;"></div>

  <div id="sinal_box">
    <div id="sinal_m1" class="sinal">‚è≥ Analisando M1...</div>
    <div id="sinal_m5" class="sinal">‚è≥ Analisando M5...</div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    const API_KEY = "e40e3e9537e64004b53f65b4f8b73901";
    let currentPair = "EUR/USD";

    // Fun√ß√£o para tocar o som de alerta
    function tocarAlerta() {
      const audio = new Audio('https://www.soundjay.com/button/beep-07.wav');
      audio.play();
    }

    function formatSymbolForTV(pair) {
      return "OANDA:" + pair.replace("/", "");
    }

    function carregarGraficoTV(pair) {
      const symbol = formatSymbolForTV(pair);
      document.getElementById("tradingview_chart").innerHTML = "";
      new TradingView.widget({
        "width": 980,
        "height": 600,
        "symbol": symbol,
        "interval": "1",
        "timezone": "Etc/UTC",
        "theme": "light",
        "style": "1",
        "locale": "br",
        "container_id": "tradingview_chart"
      });
    }

    async function buscarCandle(intervalo) {
      const url = `https://api.twelvedata.com/time_series?symbol=${currentPair}&interval=${intervalo}&outputsize=2&apikey=${API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "error") return { error: data.message };
        const vela = data.values[0]; // √∫ltima vela
        return {
          datetime: vela.datetime,
          o: parseFloat(vela.open),
          h: parseFloat(vela.high),
          l: parseFloat(vela.low),
          c: parseFloat(vela.close)
        };
      } catch {
        return { error: "Erro ao conectar com a API." };
      }
    }

    function analisarDirecao(vela) {
      const corpo = Math.abs(vela.o - vela.c);
      const pavioSuperior = vela.h - Math.max(vela.o, vela.c);
      const pavioInferior = Math.min(vela.o, vela.c) - vela.l;

      const rejeicao = corpo < 0.0003 &&
        (pavioSuperior > corpo * 1.5 || pavioInferior > corpo * 1.5);

      if (!rejeicao) return null;

      // Dire√ß√£o: se pavio inferior √© maior, tend√™ncia de alta (CALL), se superior, PUT
      if (pavioInferior > pavioSuperior) return "CALL";
      if (pavioSuperior > pavioInferior) return "PUT";

      return null;
    }

    async function analisar(intervalo, elementoId) {
      const vela = await buscarCandle(intervalo);
      const el = document.getElementById(elementoId);

      if (vela.error) {
        el.textContent = `Erro (${intervalo.toUpperCase()}): ${vela.error}`;
        el.style.color = "red";
        return;
      }

      const direcao = analisarDirecao(vela);
      if (direcao) {
        el.innerHTML = `üö® <span class="alerta">ENTRADA SUGERIDA (${intervalo.toUpperCase()}): ${direcao}</span><br>üïê Hor√°rio da vela: ${vela.datetime}`;
        el.style.color = direcao === "CALL" ? "green" : "red";
        // Tocar o alerta sonoro quando gerar sinal
        tocarAlerta();
      } else {
        el.textContent = `Sem sinal no momento (${intervalo.toUpperCase()})`;
        el.style.color = "gray";
      }
    }

    function rodarAnalise() {
      analisar("1min", "sinal_m1");
      analisar("5min", "sinal_m5");
    }

    document.getElementById("pairSelect").addEventListener("change", (e) => {
      currentPair = e.target.value;
      carregarGraficoTV(currentPair);
      rodarAnalise();
    });

    carregarGraficoTV(currentPair);
    rodarAnalise();
    setInterval(rodarAnalise, 60000);
  </script>
</body>
</html>
