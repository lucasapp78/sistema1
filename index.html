<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Locacao - Vers칚o Avan칞ada</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card-title { font-weight: bold; }
    footer { font-size: 0.9em; }
  </style>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0d6efd" />
</head>
<body class="container py-4">

  <h1 class="text-center text-primary mb-4">游닍 Hist칩rico de Loca칞칚o - Pulm칚o CD 03</h1>

  <!-- Se칞칚o Adicionar Produto -->
  <section>
    <h4 class="text-secondary">Adicionar Produto</h4>
    <div class="row g-2">
      <div class="col-md-4"><input id="nome" class="form-control" placeholder="Nome do Produto"></div>
      <div class="col-md-2">
        <select id="pe" class="form-select">
          <option value="">PE</option>
          <script>for (let i = 1; i <= 14; i++) document.write(`<option value="${i}">PE${i}</option>`);</script>
        </select>
      </div>
      <div class="col-md-2"><input id="coluna" type="number" class="form-control" placeholder="Coluna"></div>
      <div class="col-md-2"><input id="nivel" type="number" class="form-control" placeholder="N칤vel"></div>
      <div class="col-md-2"><input id="pulmao" type="number" class="form-control" placeholder="Pulm칚o"></div>
      <div class="col-md-3 mt-2"><input id="data" type="date" class="form-control"></div>
      <div class="col-md-3 mt-2"><input id="horario" type="time" class="form-control"></div>
      <div class="col-md-3 mt-2"><input id="pessoa" class="form-control" placeholder="Respons치vel"></div>
      <div class="col-md-3 mt-2"><input id="codigoSeguranca" type="password" class="form-control" placeholder="C칩digo de Seguran칞a"></div>
      <div class="col-12 mt-3">
        <button class="btn btn-success" onclick="adicionarProduto()">Adicionar Produto</button>
        <button class="btn btn-secondary" onclick="exportarJSON()">Exportar JSON</button>
        <button class="btn btn-info text-white" onclick="exportarExcel()">Exportar Excel</button>
        <input type="file" id="importarArquivo" accept=".json" class="form-control mt-2">
        <button class="btn btn-dark mt-2" onclick="importarJSON()">Importar JSON</button>
      </div>
    </div>
  </section>

  <hr class="my-4" />

  <!-- Se칞칚o de Filtro -->
  <section>
    <h4 class="text-secondary">Buscar Produto</h4>
    <div class="row g-2">
      <div class="col-md-3">
        <select id="buscarPe" class="form-select">
          <option value="">Filtrar por PE</option>
          <script>for (let i = 1; i <= 14; i++) document.write(`<option value="${i}">PE${i}</option>`);</script>
        </select>
      </div>
      <div class="col-md-3">
        <input id="buscarPulmao" type="number" class="form-control" placeholder="Filtrar por Pulm칚o">
      </div>
      <div class="col-md-3">
        <input id="buscarNome" class="form-control" placeholder="Filtrar por Nome">
      </div>
      <div class="col-md-3">
        <input id="buscarData" type="date" class="form-control" placeholder="Filtrar por Data">
      </div>
      <div class="col-md-3">
        <input id="buscarPessoa" class="form-control" placeholder="Filtrar por Respons치vel">
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" onclick="pesquisar()">Pesquisar</button>
      </div>
    </div>
  </section>

  <!-- Resultados -->
  <section id="resultado" class="mt-4"></section>

  <!-- Tabela de Produtos -->
  <section id="tabelaProdutos" class="mt-4">
    <h4 class="text-secondary">游늶 Tabela Completa de Produtos</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>PE</th>
            <th>Coluna</th>
            <th>N칤vel</th>
            <th>Pulm칚o</th>
            <th>Data</th>
            <th>Hor치rio</th>
            <th>Respons치vel</th>
          </tr>
        </thead>
        <tbody id="corpoTabela"></tbody>
      </table>
    </div>
  </section>

  <!-- Gr치fico -->
  <section class="mt-5">
    <h4 class="text-secondary">游늵 Gr치fico de Produtos por Dia</h4>
    <canvas id="graficoProdutos" height="100"></canvas>
  </section>
  
  <!-- Estat칤sticas -->
  <section id="estatisticas" class="mt-5">
    <h4 class="text-secondary">游늳 Estat칤sticas Gerais</h4>
    <div class="row" id="cardsEstatisticas">
      <!-- Cards gerados via JS -->
    </div>
  </section>

  <footer class="text-center text-muted mt-5">
    Desenvolvido por Lucas Santana - Vers칚o Avan칞ada
  </footer>

  <script>
    let db, grafico;

    // Fun칞칚o para abrir o banco de dados
    function abrirDB() {
      const request = indexedDB.open("estoqueDB", 2);
      request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains("produtos")) {
          db.createObjectStore("produtos", { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = function(event) {
        db = event.target.result;
        const tx = db.transaction("produtos", "readonly");
        const store = tx.objectStore("produtos");
        store.count().onsuccess = function(event) {
          if (event.target.result === 0) {
            carregarDadosDoGitHub();  // Carrega os dados do GitHub
          } else {
            atualizarLista();
          }
        };
      };
    }

    // Fun칞칚o para carregar os dados do GitHub
    async function carregarDadosDoGitHub() {
      const githubRawURL = "https://raw.githubusercontent.com/lucasapp78/sistema/refs/heads/main/DADOS.JSON";
      try {
        const res = await fetch(githubRawURL);
        if (!res.ok) throw new Error("Arquivo remoto n칚o encontrado");
        const dados = await res.json();
        const tx = db.transaction("produtos", "readwrite");
        const store = tx.objectStore("produtos");
        dados.forEach(p => store.add(p));
        tx.oncomplete = atualizarLista;
      } catch (err) {
        console.warn("丘멆잺 N칚o foi poss칤vel carregar dados do GitHub:", err);
      }
    }

    // Fun칞칚o para atualizar a lista de produtos
    function atualizarLista() {
      gerarEstatisticas();
      pesquisar();
      listarProdutosEmTabela();
      gerarGraficoProdutosPorDia();
    }

    window.onload = function () {
      abrirDB();
      const agora = new Date();
      document.getElementById("data").value = agora.toISOString().split("T")[0];
      document.getElementById("horario").value = agora.toTimeString().slice(0, 5);
      document.getElementById("nome").focus();
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
